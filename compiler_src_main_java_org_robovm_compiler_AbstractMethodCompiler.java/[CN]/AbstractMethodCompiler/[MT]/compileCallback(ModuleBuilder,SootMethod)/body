{
  validateCallbackMethod(method);
  Function callbackFn=FunctionBuilder.callback(method);
  moduleBuilder.addFunction(callbackFn);
  Value env=call(callbackFn,BC_ATTACH_THREAD_FROM_CALLBACK);
  pushCallbackFrame(callbackFn,env);
  ArrayList<Value> args=new ArrayList<Value>();
  args.add(env);
  for (  VariableRef ref : callbackFn.getParameterRefs()) {
    if (ref.getType() == I8_PTR) {
      Variable tmp=callbackFn.newVariable(I64);
      callbackFn.add(new Ptrtoint(tmp,ref,I64));
      ref=tmp.ref();
    }
    args.add(ref);
  }
  String targetName=mangleMethod(method);
  if (method.isSynchronized()) {
    targetName+="_synchronized";
  }
  FunctionRef targetFn=new FunctionRef(targetName,getFunctionType(method));
  BasicBlockRef bbSuccess=callbackFn.newBasicBlockRef(new Label("success"));
  BasicBlockRef bbFailure=callbackFn.newBasicBlockRef(new Label("failure"));
  trycatchAllEnter(callbackFn,env,bbSuccess,bbFailure);
  callbackFn.newBasicBlock(bbSuccess.getLabel());
  Value result=call(callbackFn,targetFn,args);
  if (callbackFn.getType().getReturnType() == I8_PTR) {
    Variable resultI8Ptr=callbackFn.newVariable(I8_PTR);
    callbackFn.add(new Inttoptr(resultI8Ptr,result,I8_PTR));
    result=resultI8Ptr.ref();
  }
  trycatchLeave(callbackFn,env);
  popCallbackFrame(callbackFn,env);
  call(callbackFn,BC_DETACH_THREAD_FROM_CALLBACK,env);
  callbackFn.add(new Ret(result));
  callbackFn.newBasicBlock(bbFailure.getLabel());
  trycatchLeave(callbackFn,env);
  popCallbackFrame(callbackFn,env);
  call(callbackFn,BC_DETACH_THREAD_FROM_CALLBACK,env);
  call(callbackFn,BC_THROW_IF_EXCEPTION_OCCURRED,env);
  callbackFn.add(new Unreachable());
}
