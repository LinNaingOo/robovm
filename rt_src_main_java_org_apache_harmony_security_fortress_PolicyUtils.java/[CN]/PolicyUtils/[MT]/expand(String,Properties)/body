{
  final String START_MARK="${";
  final String END_MARK="}";
  final int START_OFFSET=START_MARK.length();
  final int END_OFFSET=END_MARK.length();
  StringBuilder result=new StringBuilder(str);
  int start=result.indexOf(START_MARK);
  while (start >= 0) {
    int end=result.indexOf(END_MARK,start);
    if (end >= 0) {
      String key=result.substring(start + START_OFFSET,end);
      String value=properties.getProperty(key);
      if (value != null) {
        result.replace(start,end + END_OFFSET,value);
        start+=value.length();
      }
 else {
        throw new ExpansionFailedException(Messages.getString("security.14F",key));
      }
    }
    start=result.indexOf(START_MARK,start);
  }
  return result.toString();
}
