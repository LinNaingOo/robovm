{
synchronized (writeLock) {
    if (!source.hasRemaining()) {
      return 0;
    }
    int writeCount=0;
    try {
      int pos=source.position();
      int length=source.remaining();
      if (isBlocking()) {
        begin();
      }
      if (source.isDirect()) {
        long address=AddressUtil.getDirectBufferAddress(source);
        writeCount=networkSystem.writeDirect(fd,address + pos,length);
      }
 else       if (source.hasArray()) {
        pos+=source.arrayOffset();
        writeCount=networkSystem.write(fd,source.array(),pos,length);
      }
 else {
        byte[] array=new byte[length];
        source.get(array);
        writeCount=networkSystem.write(fd,array,0,length);
      }
      source.position(pos + writeCount);
    }
 catch (    SocketException e) {
      if (e.getCause() instanceof ErrorCodeException) {
        if (ERRCODE_SOCKET_NONBLOCKING_WOULD_BLOCK == ((ErrorCodeException)e.getCause()).getErrorCode()) {
          return writeCount;
        }
      }
      throw e;
    }
 finally {
      if (isBlocking()) {
        end(writeCount >= 0);
      }
    }
    return writeCount;
  }
}
