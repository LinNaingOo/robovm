{
  if (jarFile != null) {
    classPathFiles.add(jarFile);
  }
  if (output == null) {
    throw new IllegalArgumentException("No output dir specified");
  }
  if (classpath == null) {
    throw new IllegalArgumentException("No classpath specified");
  }
  if (target == null && mainClass == null) {
    throw new IllegalArgumentException("No target and no main class specified");
  }
  if (os == null) {
    os=detectOS();
    if (verbose) {
      System.out.println("Autodetected OS: " + os);
    }
  }
  if (arch == null) {
    arch=detectArch();
    if (verbose) {
      System.out.println("Autodetected arch: " + arch);
    }
  }
  if (verbose) {
    if (mainClass != null) {
      stdout.println("Using main class: " + mainClass);
    }
    stdout.println("Run arguments: " + runArgs);
  }
  homeOsArchLib=new File(new File(new File(home,os.toString()),arch.toString()),"lib");
  cache.mkdirs();
  llvmCache=new File(cache,"llvm");
  llvmCache.mkdirs();
  objectCache=new File(cache,"object");
  objectCache.mkdirs();
  if (target == null) {
    target=mainClass;
  }
  if (!nort) {
    bootClassPathFiles.add(new File(home,"lib/nullvm-rt.jar"));
  }
  if (bootclasspath != null) {
    for (    String p : bootclasspath.split(File.pathSeparator)) {
      bootClassPathFiles.add(new File(p));
    }
  }
  if (classpath != null) {
    for (    String p : classpath.split(File.pathSeparator)) {
      classPathFiles.add(new File(p));
    }
  }
  tmpFile=File.createTempFile("nullvm",".tmp");
  tmpFile.delete();
  tmpFile.mkdirs();
  mainCFile=new File(tmpFile,"main.c");
  FileUtils.copyURLToFile(getClass().getResource("/main.c"),mainCFile);
  symbolsMapFile=new File(tmpFile,"symbols");
  if (os == OS.linux) {
    FileUtils.copyURLToFile(getClass().getResource("/symbols.map"),symbolsMapFile);
  }
 else   if (os == OS.macosx) {
    FileUtils.copyURLToFile(getClass().getResource("/symbols.macosx"),symbolsMapFile);
  }
  Clazzes clazzes=new Clazzes(bootClassPathFiles,classPathFiles);
  List<ClasspathEntry> classpathEntries=new ArrayList<ClasspathEntry>();
  for (  Path path : clazzes.getBootclasspathPaths()) {
    classpathEntries.add(createClasspathEntry(path,true));
  }
  for (  Path path : clazzes.getClasspathPaths()) {
    classpathEntries.add(createClasspathEntry(path,false));
  }
  SootClassCompiler.init(clazzes,getChangedClasses(classpathEntries));
  output.mkdirs();
  build(classpathEntries);
  if (run) {
    List<String> bootclasspathContents=new ArrayList<String>();
    List<String> classpathContents=new ArrayList<String>();
    for (    ClasspathEntry entry : classpathEntries) {
      if (entry.isInBootClasspath()) {
        bootclasspathContents.add(entry.getPath().getFile().getAbsolutePath());
      }
 else {
        classpathContents.add(entry.getPath().getFile().getAbsolutePath());
      }
    }
    FileUtils.writeStringToFile(new File(output,"bootclasspath"),join(bootclasspathContents,"\r\n"),"UTF-8");
    FileUtils.writeStringToFile(new File(output,"classpath"),join(classpathContents,"\r\n"),"UTF-8");
    runTarget();
  }
 else {
    FileUtils.copyFileToDirectory(new File(new File(home,"lib"),"libnullvm" + (os == OS.linux ? ".so" : ".dylib")),output);
    FileUtils.copyFileToDirectory(new File(new File(home,"lib"),"libnullvm-rt" + (os == OS.linux ? ".so" : ".dylib")),output);
    File libBoot=new File(new File(output,"lib"),"boot");
    libBoot.mkdirs();
    File libMain=new File(new File(output,"lib"),"main");
    libMain.mkdirs();
  }
}
