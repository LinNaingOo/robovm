{
  ExecutorService executor=Executors.newSingleThreadExecutor();
  Future<TestSSLHandshakeCallbacks> future=executor.submit(new Callable<TestSSLHandshakeCallbacks>(){
    public TestSSLHandshakeCallbacks call() throws Exception {
      Socket socket=(client ? new Socket(listener.getInetAddress(),listener.getLocalPort()) : listener.accept());
      if (timeout == -1) {
        return null;
      }
      FileDescriptor fd=socket.getFileDescriptor$();
      int c=hooks.getContext();
      int s=hooks.beforeHandshake(c);
      TestSSLHandshakeCallbacks callback=new TestSSLHandshakeCallbacks(s,hooks);
      if (DEBUG) {
        System.out.println("ssl=0x" + Integer.toString(s,16) + " handshake"+ " context=0x"+ Integer.toString(c,16)+ " socket="+ socket+ " fd="+ fd+ " timeout="+ timeout+ " client="+ client);
      }
      int session=NativeCrypto.SSL_do_handshake(s,fd,callback,timeout,client,npnProtocols);
      if (DEBUG) {
        System.out.println("ssl=0x" + Integer.toString(s,16) + " handshake"+ " session=0x"+ Integer.toString(session,16));
      }
      hooks.afterHandshake(session,s,c,socket,fd,callback);
      return callback;
    }
  }
);
  executor.shutdown();
  return future;
}
