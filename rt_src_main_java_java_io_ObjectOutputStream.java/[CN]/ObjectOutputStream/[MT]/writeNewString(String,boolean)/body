{
  long count=output.countUTFBytes(object);
  byte[] buffer;
  int offset=0;
  if (count <= 0xffff) {
    buffer=new byte[(int)count + 3];
    buffer[offset++]=TC_STRING;
    offset=output.writeShortToBuffer((short)count,buffer,offset);
  }
 else {
    buffer=new byte[(int)count + 9];
    buffer[offset++]=TC_LONGSTRING;
    offset=output.writeLongToBuffer(count,buffer,offset);
  }
  offset=output.writeUTFBytesToBuffer(object,count,buffer,offset);
  output.write(buffer,0,offset);
  Integer handle=nextHandle();
  if (!unshared) {
    objectsWritten.put(object,handle);
  }
  return handle;
}
