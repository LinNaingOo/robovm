{
  setExtensionsTable(getStylesheet());
synchronized (m_serializationHandler) {
    m_hasBeenReset=false;
    XPathContext xctxt=getXPathContext();
    DTM dtm=xctxt.getDTM(node);
    try {
      pushGlobalVars(node);
      StylesheetRoot stylesheet=this.getStylesheet();
      int n=stylesheet.getGlobalImportCount();
      for (int i=0; i < n; i++) {
        StylesheetComposed imported=stylesheet.getGlobalImport(i);
        int includedCount=imported.getIncludeCountComposed();
        for (int j=-1; j < includedCount; j++) {
          Stylesheet included=imported.getIncludeComposed(j);
          included.runtimeInit(this);
          for (ElemTemplateElement child=included.getFirstChildElem(); child != null; child=child.getNextSiblingElem()) {
            child.runtimeInit(this);
          }
        }
      }
      DTMIterator dtmIter=new org.apache.xpath.axes.SelfIteratorNoPredicate();
      dtmIter.setRoot(node,xctxt);
      xctxt.pushContextNodeList(dtmIter);
      try {
        this.applyTemplateToNode(null,null,node);
      }
  finally {
        xctxt.popContextNodeList();
      }
      if (null != m_serializationHandler) {
        m_serializationHandler.endDocument();
      }
    }
 catch (    Exception se) {
      while (se instanceof org.apache.xml.utils.WrappedRuntimeException) {
        Exception e=((org.apache.xml.utils.WrappedRuntimeException)se).getException();
        if (null != e)         se=e;
      }
      if (null != m_serializationHandler) {
        try {
          if (se instanceof org.xml.sax.SAXParseException)           m_serializationHandler.fatalError((org.xml.sax.SAXParseException)se);
 else           if (se instanceof TransformerException) {
            TransformerException te=((TransformerException)se);
            SAXSourceLocator sl=new SAXSourceLocator(te.getLocator());
            m_serializationHandler.fatalError(new org.xml.sax.SAXParseException(te.getMessage(),sl,te));
          }
 else {
            m_serializationHandler.fatalError(new org.xml.sax.SAXParseException(se.getMessage(),new SAXSourceLocator(),se));
          }
        }
 catch (        Exception e) {
        }
      }
      if (se instanceof TransformerException) {
        m_errorHandler.fatalError((TransformerException)se);
      }
 else       if (se instanceof org.xml.sax.SAXParseException) {
        m_errorHandler.fatalError(new TransformerException(se.getMessage(),new SAXSourceLocator((org.xml.sax.SAXParseException)se),se));
      }
 else {
        m_errorHandler.fatalError(new TransformerException(se));
      }
    }
 finally {
      this.reset();
    }
  }
}
