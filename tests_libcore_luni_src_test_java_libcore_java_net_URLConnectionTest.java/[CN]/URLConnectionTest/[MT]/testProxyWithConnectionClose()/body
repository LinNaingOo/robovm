{
  TestSSLContext testSSLContext=TestSSLContext.create();
  server.useHttps(testSSLContext.serverContext.getSocketFactory(),true);
  server.enqueue(new MockResponse().setSocketPolicy(SocketPolicy.UPGRADE_TO_SSL_AT_END).clearHeaders());
  server.enqueue(new MockResponse().setBody("this response comes via a proxy"));
  server.play();
  URL url=new URL("https://android.com/foo");
  HttpsURLConnection connection=(HttpsURLConnection)url.openConnection(server.toProxyAddress());
  connection.setRequestProperty("Connection","close");
  connection.setSSLSocketFactory(testSSLContext.clientContext.getSocketFactory());
  connection.setHostnameVerifier(new RecordingHostnameVerifier());
  assertContent("this response comes via a proxy",connection);
}
