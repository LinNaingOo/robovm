{
  Charset cs=Charset.forName("UTF-32BE");
  CharsetEncoder e=cs.newEncoder();
  e.onMalformedInput(cea);
  e.onUnmappableCharacter(cea);
  ByteBuffer bb=ByteBuffer.allocate(128);
  CoderResult cr=e.encode(CharBuffer.wrap(new char[]{'\ud842'}),bb,false);
  assertEquals(CoderResult.UNDERFLOW,cr);
  assertEquals(0,bb.position());
  cr=e.encode(CharBuffer.wrap(new char[]{'\udf9f'}),bb,false);
  if (cea == CodingErrorAction.REPORT) {
    assertTrue(cr.toString(),cr.isMalformed());
    assertEquals(1,cr.length());
    return;
  }
  assertEquals(CoderResult.UNDERFLOW,cr);
  int expectedPosition=0;
  if (cea == CodingErrorAction.REPLACE) {
    expectedPosition=4;
    assertEquals(expectedPosition,bb.position());
    System.err.println(Arrays.toString(Arrays.copyOfRange(bb.array(),0,bb.position())));
    assertEquals((byte)0x00,bb.get(0));
    assertEquals((byte)0x00,bb.get(1));
    assertEquals((byte)0xff,bb.get(2));
    assertEquals((byte)0xfd,bb.get(3));
  }
  assertEquals(expectedPosition,bb.position());
  cr=e.encode(CharBuffer.wrap(new char[]{}),bb,true);
  assertEquals(CoderResult.UNDERFLOW,cr);
  assertEquals(expectedPosition,bb.position());
  cr=e.flush(bb);
  assertEquals(CoderResult.UNDERFLOW,cr);
  assertEquals(expectedPosition,bb.position());
}
