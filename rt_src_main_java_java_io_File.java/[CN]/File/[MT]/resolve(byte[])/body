{
  int last=1, nextSize, linkSize;
  byte[] linkPath=newResult, bytes;
  boolean done, inPlace;
  for (int i=1; i <= newResult.length; i++) {
    if (i == newResult.length || newResult[i] == separatorChar) {
      done=i >= newResult.length - 1;
      if (done && linkPath.length == 1) {
        return newResult;
      }
      inPlace=false;
      if (linkPath == newResult) {
        bytes=newResult;
        if (!done) {
          inPlace=true;
          newResult[i]='\0';
        }
      }
 else {
        nextSize=i - last + 1;
        linkSize=linkPath.length;
        if (linkPath[linkSize - 1] == separatorChar) {
          linkSize--;
        }
        bytes=new byte[linkSize + nextSize];
        System.arraycopy(linkPath,0,bytes,0,linkSize);
        System.arraycopy(newResult,last - 1,bytes,linkSize,nextSize);
      }
      if (done) {
        return bytes;
      }
      linkPath=resolveLink(bytes,inPlace ? i : bytes.length,true);
      if (inPlace) {
        newResult[i]='/';
      }
      last=i + 1;
    }
  }
  throw new InternalError();
}
