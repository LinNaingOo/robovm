{
  if (!signerInfs.isEmpty()) {
    throw new IllegalStateException("this method can only be used with SignerInfoGenerator");
  }
  ASN1EncodableVector digestAlgs=new ASN1EncodableVector();
  ASN1EncodableVector signerInfos=new ASN1EncodableVector();
  digests.clear();
  for (Iterator it=_signers.iterator(); it.hasNext(); ) {
    SignerInformation signer=(SignerInformation)it.next();
    digestAlgs.add(CMSSignedHelper.INSTANCE.fixAlgID(signer.getDigestAlgorithmID()));
    signerInfos.add(signer.toASN1Structure());
  }
  ASN1ObjectIdentifier contentTypeOID=content.getContentType();
  ASN1OctetString octs=null;
  if (content != null) {
    ByteArrayOutputStream bOut=null;
    if (encapsulate) {
      bOut=new ByteArrayOutputStream();
    }
    OutputStream cOut=CMSUtils.attachSignersToOutputStream(signerGens,bOut);
    cOut=CMSUtils.getSafeOutputStream(cOut);
    try {
      content.write(cOut);
      cOut.close();
    }
 catch (    IOException e) {
      throw new CMSException("data processing exception: " + e.getMessage(),e);
    }
    if (encapsulate) {
      octs=new BEROctetString(bOut.toByteArray());
    }
  }
  for (Iterator it=signerGens.iterator(); it.hasNext(); ) {
    SignerInfoGenerator sGen=(SignerInfoGenerator)it.next();
    SignerInfo inf=sGen.generate(contentTypeOID);
    digestAlgs.add(inf.getDigestAlgorithm());
    signerInfos.add(inf);
    byte[] calcDigest=sGen.getCalculatedDigest();
    if (calcDigest != null) {
      digests.put(inf.getDigestAlgorithm().getAlgorithm().getId(),calcDigest);
    }
  }
  ASN1Set certificates=null;
  if (certs.size() != 0) {
    certificates=CMSUtils.createBerSetFromList(certs);
  }
  ASN1Set certrevlist=null;
  if (crls.size() != 0) {
    certrevlist=CMSUtils.createBerSetFromList(crls);
  }
  ContentInfo encInfo=new ContentInfo(contentTypeOID,octs);
  SignedData sd=new SignedData(new DERSet(digestAlgs),encInfo,certificates,certrevlist,new DERSet(signerInfos));
  ContentInfo contentInfo=new ContentInfo(CMSObjectIdentifiers.signedData,sd);
  return new CMSSignedData(content,contentInfo);
}
