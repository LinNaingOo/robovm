{
  int redirect=0;
  while (true) {
    if (!sendRequest()) {
      return;
    }
    if (responseCode == HTTP_PROXY_AUTH) {
      if (!usingProxy()) {
        throw new IOException(Messages.getString("luni.2D"));
      }
      String challenge=resHeader.get("Proxy-Authenticate");
      if (challenge == null) {
        throw new IOException(Messages.getString("luni.2E"));
      }
      endRequest();
      disconnect();
      connected=false;
      String credentials=getAuthorizationCredentials(challenge);
      if (credentials == null) {
        break;
      }
      setRequestProperty("Proxy-Authorization",credentials);
      continue;
    }
    if (responseCode == HTTP_UNAUTHORIZED) {
      String challenge=resHeader.get("WWW-Authenticate");
      if (challenge == null) {
        break;
      }
      endRequest();
      disconnect();
      connected=false;
      String credentials=getAuthorizationCredentials(challenge);
      if (credentials == null) {
        break;
      }
      setRequestProperty("Authorization",credentials);
      continue;
    }
    if (getInstanceFollowRedirects()) {
      if ((responseCode == HTTP_MULT_CHOICE || responseCode == HTTP_MOVED_PERM || responseCode == HTTP_MOVED_TEMP || responseCode == HTTP_SEE_OTHER || responseCode == HTTP_USE_PROXY) && os == null) {
        if (++redirect > 4) {
          throw new ProtocolException(Messages.getString("luni.2F"));
        }
        String location=getHeaderField("Location");
        if (location != null) {
          if (responseCode == HTTP_USE_PROXY) {
            int start=0;
            if (location.startsWith(url.getProtocol() + ':')) {
              start=url.getProtocol().length() + 1;
            }
            if (location.startsWith("//",start)) {
              start+=2;
            }
            setProxy(location.substring(start));
          }
 else {
            url=new URL(url,location);
            hostName=url.getHost();
            hostPort=-1;
          }
          endRequest();
          disconnect();
          connected=false;
          continue;
        }
      }
    }
    break;
  }
  getContentStream();
}
