{
  if (!doOutput) {
    throw new ProtocolException(Messages.getString("luni.29"));
  }
  if (sentRequest) {
    throw new ProtocolException(Messages.getString("luni.2A"));
  }
  if (os != null) {
    return os;
  }
  if (method == GET) {
    method=POST;
  }
  if (method != PUT && method != POST) {
    throw new ProtocolException(Messages.getString("luni.2B",method));
  }
  int limit=-1;
  String contentLength=reqHeader.get("Content-Length");
  if (contentLength != null) {
    limit=Integer.parseInt(contentLength);
  }
  String encoding=reqHeader.get("Transfer-Encoding");
  if (httpVersion > 0 && encoding != null) {
    encoding=encoding.toLowerCase();
    if ("chunked".equals(encoding)) {
      sendChunked=true;
      limit=-1;
    }
  }
  if (chunkLength > 0) {
    sendChunked=true;
    limit=-1;
  }
  boolean fixedMode=false;
  if (fixedContentLength >= 0) {
    limit=fixedContentLength;
    fixedMode=true;
  }
  if ((httpVersion > 0 && sendChunked) || limit >= 0) {
    os=new HttpOutputStream(limit,fixedMode);
    doRequest();
    return os;
  }
  if (!connected) {
    connect();
  }
  return os=new HttpOutputStream();
}
