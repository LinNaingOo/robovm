{
  try (LockdowndClient lockdowndClient=new LockdowndClient(device,getClass().getSimpleName(),true)){
    final LibIMobileDeviceException[] ex=new LibIMobileDeviceException[1];
    final CountDownLatch countDownLatch=new CountDownLatch(1);
    LockdowndServiceDescriptor instproxyService=lockdowndClient.startService(InstallationProxyClient.SERVICE_NAME);
    try (InstallationProxyClient instClient=new InstallationProxyClient(device,instproxyService)){
      instClient.upgrade("/PublicStaging/" + localAppPath.getName(),new Options().packageType(localAppPath.isDirectory() ? PackageType.Developer : null),new StatusCallback(){
        @Override public void progress(        String status,        int percentComplete){
          debug("[%3d%%] %s",50 + percentComplete / 2,status);
          if (installStatusCallback != null) {
            installStatusCallback.progress(status,percentComplete);
          }
        }
        @Override public void success(){
          try {
            debug("[100%] Installation complete");
            if (installStatusCallback != null) {
              installStatusCallback.success();
            }
          }
  finally {
            countDownLatch.countDown();
          }
        }
        @Override public void error(        String message){
          try {
            ex[0]=new LibIMobileDeviceException(message);
            debug("Error: %s",message);
            if (installStatusCallback != null) {
              installStatusCallback.error(message);
            }
          }
  finally {
            countDownLatch.countDown();
          }
        }
      }
);
      countDownLatch.await();
    }
     if (ex[0] != null) {
      throw ex[0];
    }
  }
 }
