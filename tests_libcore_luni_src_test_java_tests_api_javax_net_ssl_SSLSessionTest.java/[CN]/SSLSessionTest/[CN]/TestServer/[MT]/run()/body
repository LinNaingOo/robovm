{
  try {
    store=provideKeys ? getKeyStore(keys) : null;
    KeyManager[] keyManagers=store != null ? getKeyManagers(store) : null;
    TrustManager[] trustManagers=new TrustManager[]{trustManager};
    SSLContext sslContext=SSLContext.getInstance("TLS");
    sslContext.init(keyManagers,trustManagers,null);
    SSLServerSocket serverSocket=(SSLServerSocket)sslContext.getServerSocketFactory().createServerSocket();
    if (clientAuth == CLIENT_AUTH_WANTED) {
      serverSocket.setWantClientAuth(true);
    }
 else     if (clientAuth == CLIENT_AUTH_NEEDED) {
      serverSocket.setNeedClientAuth(true);
    }
 else {
      serverSocket.setWantClientAuth(false);
    }
    serverSocket.bind(new InetSocketAddress(port));
    SSLSocket clientSocket=(SSLSocket)serverSocket.accept();
    InputStream istream=clientSocket.getInputStream();
    byte[] buffer=new byte[1024];
    istream.read(buffer);
    OutputStream ostream=clientSocket.getOutputStream();
    ostream.write(testData.getBytes());
    ostream.flush();
    while (notFinished) {
      Thread.currentThread().sleep(500);
    }
    clientSocket.close();
    serverSocket.close();
  }
 catch (  Exception ex) {
    exception=ex;
  }
}
