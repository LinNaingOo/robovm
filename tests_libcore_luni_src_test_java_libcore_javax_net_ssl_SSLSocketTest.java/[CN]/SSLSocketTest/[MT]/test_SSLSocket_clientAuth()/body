{
  TestSSLContext c=TestSSLContext.create(TestKeyStore.getClientCertificate(),TestKeyStore.getServer());
  SSLSocket client=(SSLSocket)c.clientContext.getSocketFactory().createSocket(c.host,c.port);
  final SSLSocket server=(SSLSocket)c.serverSocket.accept();
  Thread thread=new Thread(new Runnable(){
    public void run(){
      try {
        assertFalse(server.getWantClientAuth());
        assertFalse(server.getNeedClientAuth());
        server.setWantClientAuth(true);
        assertTrue(server.getWantClientAuth());
        assertFalse(server.getNeedClientAuth());
        server.setNeedClientAuth(true);
        assertFalse(server.getWantClientAuth());
        assertTrue(server.getNeedClientAuth());
        server.setWantClientAuth(true);
        assertTrue(server.getWantClientAuth());
        assertFalse(server.getNeedClientAuth());
        server.startHandshake();
      }
 catch (      RuntimeException e) {
        throw e;
      }
catch (      Exception e) {
        throw new RuntimeException(e);
      }
    }
  }
);
  thread.start();
  client.startHandshake();
  assertNotNull(client.getSession().getLocalCertificates());
  TestKeyStore.assertChainLength(client.getSession().getLocalCertificates());
  TestSSLContext.assertClientCertificateChain(c.clientTrustManager,client.getSession().getLocalCertificates());
  thread.join();
  client.close();
  server.close();
  c.close();
}
