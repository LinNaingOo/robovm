{
  int tempLen=data.length;
  for (  char element : data) {
    if ((element > 255) || codes[element] < 0)     --tempLen;
  }
  int len=(tempLen / 4) * 3;
  if ((tempLen % 4) == 3)   len+=2;
  if ((tempLen % 4) == 2)   len+=1;
  byte[] out=new byte[len];
  int shift=0;
  int accum=0;
  int index=0;
  for (  char element : data) {
    int value=(element > 255) ? -1 : codes[element];
    if (value >= 0) {
      accum<<=6;
      shift+=6;
      accum|=value;
      if (shift >= 8) {
        shift-=8;
        out[index++]=(byte)((accum >> shift) & 0xff);
      }
    }
  }
  if (index != out.length) {
    throw new Error("Miscalculated data length (wrote " + index + " instead of "+ out.length+ ")");
  }
  return out;
}
