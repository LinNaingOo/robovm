{
  Charset utf8=Charset.forName("utf-8");
  CharsetEncoder encoder=utf8.newEncoder();
  CharBuffer char1=CharBuffer.wrap("\ud800");
  CharBuffer char2=CharBuffer.wrap("\udc00");
  ByteBuffer bytes=ByteBuffer.allocate(4);
  encoder.reset();
  CoderResult result=encoder.encode(char1,bytes,false);
  assertTrue(result.isUnderflow());
  assertEquals(4,bytes.remaining());
  result=encoder.encode(char2,bytes,true);
  assertTrue(result.isUnderflow());
  assertEquals(0,bytes.remaining());
  assertEquals(4,bytes.limit());
  assertEquals((byte)0xf0,bytes.get(0));
  assertEquals((byte)0x90,bytes.get(1));
  assertEquals((byte)0x80,bytes.get(2));
  assertEquals((byte)0x80,bytes.get(3));
  bytes.flip();
  CharBuffer chars=utf8.newDecoder().decode(bytes);
  assertEquals(0,bytes.remaining());
  assertEquals(2,chars.limit());
  assertEquals(0xd800,chars.get(0));
  assertEquals(0xdc00,chars.get(1));
}
