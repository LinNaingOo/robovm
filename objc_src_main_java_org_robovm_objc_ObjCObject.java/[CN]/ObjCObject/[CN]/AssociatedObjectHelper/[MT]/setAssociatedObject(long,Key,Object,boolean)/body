{
  long wrapper=ObjCRuntime.objc_getAssociatedObject(handle,key.hashCode());
  if (wrapper != 0L && weak) {
    VM.unregisterDisappearingLink(wrapper + VALUE_IVAR_OFFSET);
  }
  if (value == null) {
    ObjCRuntime.objc_setAssociatedObject(handle,key.hashCode(),0L,0);
  }
 else {
    wrapper=ObjCRuntime.ptr_objc_msgSend(CLS,alloc.getHandle());
    if (wrapper == 0L) {
      throw new OutOfMemoryError();
    }
    wrapper=ObjCRuntime.ptr_objc_msgSend(wrapper,init.getHandle());
    long address=VM.getObjectAddress(value);
    VM.setPointer(wrapper + VALUE_IVAR_OFFSET,address);
    VM.setInt(wrapper + KEY_IVAR_OFFSET,key.ordinal());
    if (weak) {
      VM.registerDisappearingLink(wrapper + VALUE_IVAR_OFFSET,value);
    }
    ObjCRuntime.objc_setAssociatedObject(handle,key.hashCode(),wrapper,OBJC_ASSOCIATION_RETAIN_NONATOMIC);
    ObjCRuntime.void_objc_msgSend(wrapper,release.getHandle());
  }
}
